name: MegaLinter
on:
  push:
    branches: [main, master, claude/**]
    paths: ["**.yml", "**.yaml", "**.toml", "**.json", "**.json5", "**.jsonc", "**.properties", ".github/workflows/mega-linter.yml"]
  pull_request:
    branches: [main, master, claude/**]
  workflow_dispatch:
concurrency:
  group: ${{ github.ref }}-${{ github.workflow }}
  cancel-in-progress: true
permissions:
  contents: read
jobs:
  megalinter:
    name: MegaLinter
    runs-on: ubuntu-latest
    permissions:
      contents: write
      issues: write
      pull-requests: write
    steps:
      - name: Checkout
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0
      - name: MegaLinter
        id: ml
        uses: oxsecurity/megalinter@55a59b24a441e0e1943080d4a512d827710d4a9d # v9.2.0
        env:
          APPLY_FIXES: all
          APPLY_FIXES_EVENT: all
          APPLY_FIXES_MODE: commit
          ENABLE_LINTERS: YAML_YAMLLINT,YAML_PRETTIER,JSON_JSONLINT,JSON_PRETTIER,JSON_NPM_PACKAGE_JSON_LINT,TOML_TAPLO
          DISABLE_ERRORS_LINTERS: SPELL_CSPELL,YAML_YAMLLINT,YAML_V8R,YAML_PRETTIER,REPOSITORY_SEMGREP,REPOSITORY_GRYPE,REPOSITORY_DEVSKIM,PYTHON_BANDIT,ACTION_ACTIONLINT,MARKDOWN_MARKDOWNLINT,EDITORCONFIG,YAML
          YAML_YAMLLINT_CONFIG_FILE: .yamllint.yml
          YAML_PRETTIER_CONFIG_FILE: .prettierrc.yml
          JSON_PRETTIER_CONFIG_FILE: .prettierrc.yml
          FILEIO_REPORTER: false
          GITHUB_TOKEN: ${{ secrets.PAT || secrets.GITHUB_TOKEN }}
      - name: Archive reports
        if: success() || failure()
        uses: actions/upload-artifact@330a01c490aca151604b8cf639adc76d48f6c5d4 # v5.0.0
        with:
          name: MegaLinter reports
          path: |
            megalinter-reports
            mega-linter.log
      - name: Create PR with fixes
        id: cpr
        if: >
          steps.ml.outputs.has_updated_sources == 1 && (env.APPLY_FIXES_EVENT == 'all' || env.APPLY_FIXES_EVENT == github.event_name) && env.APPLY_FIXES_MODE == 'pull_request' && (github.event_name == 'push' || github.event.pull_request.head.repo.full_name == github.repository)

        uses: peter-evans/create-pull-request@22a9089034f40e5a961c8808d113e2c98fb63676 # v7.0.11
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "[MegaLinter] Apply linter fixes"
          title: "[MegaLinter] Apply linter fixes"
          labels: bot
          branch: megalinter-fixes
          delete-branch: true
      - name: Comment on PR
        if: >
          steps.ml.outputs.has_updated_sources == 1 && (env.APPLY_FIXES_EVENT == 'all' || env.APPLY_FIXES_EVENT == github.event_name) && env.APPLY_FIXES_MODE == 'pull_request' && (github.event_name == 'push' || github.event.pull_request.head.repo.full_name == github.repository)

        uses: peter-evans/create-or-update-comment@e8674b075228eee787fea43ef493e45ece1004c9 # v5.0.0
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          issue-number: ${{ github.event.pull_request.number }}
          body: |
            MegaLinter found fixes. Review PR #${{ steps.cpr.outputs.pull-request-number }}
